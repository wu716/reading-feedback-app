<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-talk - è¯»ä¹¦åé¦ˆåº”ç”¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .recording-section {
            text-align: center;
        }

        .record-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .record-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }

        .record-button.recording {
            background: linear-gradient(135deg, #ff4757, #c44569);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .upload-section {
            margin-top: 20px;
        }

        .file-input {
            width: 100%;
            padding: 12px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .file-input:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .upload-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .upload-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .history-section {
            grid-column: 1 / -1;
        }

        .self-talk-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .self-talk-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .self-talk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .self-talk-date {
            color: #718096;
            font-size: 0.9rem;
        }

        .self-talk-actions {
            display: flex;
            gap: 10px;
        }

        .action-button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .play-button {
            background: #48bb78;
            color: white;
        }

        .play-button:hover {
            background: #38a169;
        }

        .delete-button {
            background: #f56565;
            color: white;
        }

        .delete-button:hover {
            background: #e53e3e;
        }

        .transcript {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            line-height: 1.6;
            color: #4a5568;
        }

        .no-transcript {
            color: #a0aec0;
            font-style: italic;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <button class="back-button" onclick="goBack()">â† è¿”å›</button>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ Self-talk</h1>
            <p>è®°å½•ä½ çš„å†…å¿ƒå¯¹è¯ï¼Œè®©æ€è€ƒæ›´æœ‰åŠ›é‡</p>
        </div>

        <div class="main-content">
            <!-- å½•éŸ³åŒºåŸŸ -->
            <div class="card recording-section">
                <h2>å¼€å§‹å½•éŸ³</h2>
                <button id="recordButton" class="record-button" onclick="toggleRecording()">
                    ğŸ¤ å¼€å§‹å½•éŸ³
                </button>
                <div id="recordingStatus" class="status" style="display: none;"></div>
                
                <div class="upload-section">
                    <h3>æˆ–ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</h3>
                    <input type="file" id="audioFile" class="file-input" accept="audio/*">
                    <button id="uploadButton" class="upload-button" onclick="uploadAudio()">
                        ä¸Šä¼ éŸ³é¢‘
                    </button>
                    <div id="uploadStatus" class="status" style="display: none;"></div>
                </div>
            </div>

            <!-- å†å²è®°å½•åŒºåŸŸ -->
            <div class="card">
                <h2>å†å²è®°å½•</h2>
                <div id="historyList">
                    <div class="loading"></div>
                    <p style="text-align: center; margin-top: 10px;">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•è¯¦æƒ… -->
        <div class="card history-section">
            <h2>æ‰€æœ‰ Self-talk è®°å½•</h2>
            <div id="allHistoryList">
                <div class="loading"></div>
                <p style="text-align: center; margin-top: 10px;">åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let audioBlob = null;

        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨');
        }

        // è¿”å›æŒ‰é’®
        function goBack() {
            // ç¡®ä¿è®¤è¯çŠ¶æ€æ­£ç¡®ä¼ é€’
            const authToken = localStorage.getItem('authToken');
            if (authToken) {
                window.location.href = '/static/index.html';
            } else {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = '/static/index.html';
            }
        }

        // åˆ‡æ¢å½•éŸ³çŠ¶æ€
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                // å°è¯•ä½¿ç”¨ WAV æ ¼å¼ï¼Œå¦‚æœä¸æ”¯æŒåˆ™å›é€€åˆ°å…¶ä»–æ ¼å¼
                let mimeType = 'audio/wav';
                if (!MediaRecorder.isTypeSupported('audio/wav')) {
                    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                        mimeType = 'audio/webm;codecs=opus';
                    } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                        mimeType = 'audio/webm';
                    } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        mimeType = 'audio/mp4';
                    } else {
                        mimeType = 'audio/webm'; // é»˜è®¤å›é€€
                    }
                }
                
                console.log('ä½¿ç”¨å½•éŸ³æ ¼å¼:', mimeType);
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType
                });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: mimeType });
                    showStatus('recordingStatus', 'å½•éŸ³å®Œæˆï¼å¯ä»¥ä¸Šä¼ äº†', 'success');
                    
                    // è‡ªåŠ¨ä¸Šä¼ å½•éŸ³
                    uploadRecording();
                };

                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('recordButton').textContent = 'â¹ï¸ åœæ­¢å½•éŸ³';
                document.getElementById('recordButton').classList.add('recording');
                showStatus('recordingStatus', 'æ­£åœ¨å½•éŸ³...', 'info');
                
            } catch (error) {
                console.error('å½•éŸ³å¤±è´¥:', error);
                showStatus('recordingStatus', 'å½•éŸ³å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™', 'error');
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                isRecording = false;
                document.getElementById('recordButton').textContent = 'ğŸ¤ å¼€å§‹å½•éŸ³';
                document.getElementById('recordButton').classList.remove('recording');
            }
        }

        // ä¸Šä¼ å½•éŸ³
        async function uploadRecording() {
            // é¦–å…ˆæ£€æŸ¥è®¤è¯ä»¤ç‰Œ
            if (!checkAuthToken()) {
                return;
            }

            if (!audioBlob) {
                showStatus('recordingStatus', 'æ²¡æœ‰å½•éŸ³æ•°æ®', 'error');
                return;
            }

            // æ ¹æ®å®é™…æ ¼å¼ç¡®å®šæ–‡ä»¶æ‰©å±•å
            let filename = 'recording';
            if (audioBlob.type.includes('wav')) {
                filename += '.wav';
            } else if (audioBlob.type.includes('webm')) {
                filename += '.webm';
            } else if (audioBlob.type.includes('mp4')) {
                filename += '.mp4';
            } else {
                filename += '.webm'; // é»˜è®¤
            }

            const formData = new FormData();
            formData.append('file', audioBlob, filename);

            try {
                showStatus('recordingStatus', 'æ­£åœ¨ä¸Šä¼ å’Œè¯†åˆ«...', 'info');
                
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/self_talks/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('recordingStatus', 'ä¸Šä¼ æˆåŠŸï¼', 'success');
                    loadHistory(); // åˆ·æ–°å†å²è®°å½•
                } else if (response.status === 401) {
                    // å¤„ç†è®¤è¯å¤±è´¥
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('authToken');
                    window.location.href = '/static/index.html';
                } else {
                    const error = await response.json().catch(() => ({ detail: 'æœªçŸ¥é”™è¯¯' }));
                    showStatus('recordingStatus', `ä¸Šä¼ å¤±è´¥: ${error.detail || 'è¯·é‡è¯•'}`, 'error');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showStatus('recordingStatus', 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 'error');
            }
        }

        // ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
        async function uploadAudio() {
            // é¦–å…ˆæ£€æŸ¥è®¤è¯ä»¤ç‰Œ
            if (!checkAuthToken()) {
                return;
            }

            const fileInput = document.getElementById('audioFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('uploadStatus', 'è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                showStatus('uploadStatus', 'æ­£åœ¨ä¸Šä¼ å’Œè¯†åˆ«...', 'info');
                
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/self_talks/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('uploadStatus', 'ä¸Šä¼ æˆåŠŸï¼', 'success');
                    fileInput.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    loadHistory(); // åˆ·æ–°å†å²è®°å½•
                } else if (response.status === 401) {
                    // å¤„ç†è®¤è¯å¤±è´¥
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('authToken');
                    window.location.href = '/static/index.html';
                } else {
                    const error = await response.json().catch(() => ({ detail: 'æœªçŸ¥é”™è¯¯' }));
                    showStatus('uploadStatus', `ä¸Šä¼ å¤±è´¥: ${error.detail || 'è¯·é‡è¯•'}`, 'error');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showStatus('uploadStatus', 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 'error');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸä¿¡æ¯
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // åŠ è½½å†å²è®°å½•
        async function loadHistory() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/self_talks/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayHistory(data.self_talks.slice(0, 3), 'historyList'); // æ˜¾ç¤ºæœ€è¿‘3æ¡
                    displayHistory(data.self_talks, 'allHistoryList'); // æ˜¾ç¤ºæ‰€æœ‰è®°å½•
                } else if (response.status === 401) {
                    // å¤„ç†è®¤è¯å¤±è´¥
                    console.warn('è®¤è¯å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('authToken');
                    window.location.href = '/static/index.html';
                } else {
                    console.error('åŠ è½½å†å²è®°å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function displayHistory(selfTalks, containerId) {
            const container = document.getElementById(containerId);
            
            if (selfTalks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0;">æš‚æ—  Self-talk è®°å½•</p>';
                return;
            }

            container.innerHTML = selfTalks.map(selfTalk => `
                <div class="self-talk-item">
                    <div class="self-talk-header">
                        <span class="self-talk-date">${new Date(selfTalk.created_at).toLocaleString('zh-CN')}</span>
                        <div class="self-talk-actions">
                            <button class="action-button play-button" onclick="playAudio(${selfTalk.id})">
                                â–¶ï¸ æ’­æ”¾
                            </button>
                            <button class="action-button delete-button" onclick="deleteSelfTalk(${selfTalk.id})">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                    <div class="transcript">
                        ${selfTalk.transcript ? selfTalk.transcript : '<span class="no-transcript">æš‚æ— è½¬å†™æ–‡å­—</span>'}
                    </div>
                </div>
            `).join('');
        }

        // æ’­æ”¾éŸ³é¢‘
        function playAudio(selfTalkId) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }
                
                // ä½¿ç”¨å—ä¿æŠ¤çš„APIæ¥å£
                const audioUrl = `/api/self_talks/${selfTalkId}/audio`;
                
                console.log('=== éŸ³é¢‘æ’­æ”¾è°ƒè¯• ===');
                console.log('Self-talk ID:', selfTalkId);
                console.log('API URL:', audioUrl);
                
                // åˆ›å»ºå¸¦è®¤è¯å¤´çš„è¯·æ±‚
                fetch(audioUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                            localStorage.removeItem('authToken');
                            window.location.href = '/static/index.html';
                        } else {
                            throw new Error('æ’­æ”¾å¤±è´¥');
                        }
                    }
                    return response.blob();
                })
                .then(blob => {
                    console.log('éŸ³é¢‘Blobå¤§å°:', blob.size);
                    const audio = new Audio(URL.createObjectURL(blob));
                    
                    audio.onerror = function(e) {
                        console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', e);
                        alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶');
                    };
                    
                    audio.onloadeddata = function() {
                        console.log('éŸ³é¢‘æ•°æ®åŠ è½½å®Œæˆ');
                    };
                    
                    audio.oncanplay = function() {
                        console.log('éŸ³é¢‘å¯ä»¥æ’­æ”¾');
                    };
                    
                    return audio.play();
                })
                .then(() => {
                    console.log('éŸ³é¢‘æ’­æ”¾å¼€å§‹');
                })
                .catch(error => {
                    console.error('è·å–éŸ³é¢‘å¤±è´¥:', error);
                    alert('è·å–éŸ³é¢‘å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            } catch (error) {
                console.error('æ’­æ”¾å¼‚å¸¸:', error);
                alert('æ’­æ”¾å¤±è´¥: ' + error.message);
            }
        }

        // æ£€æŸ¥è®¤è¯ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
        function checkAuthToken() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = '/static/index.html';
                return false;
            }
            
            try {
                // ç®€å•çš„ä»¤ç‰Œæ ¼å¼æ£€æŸ¥
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('ä»¤ç‰Œæ ¼å¼é”™è¯¯');
                }
                
                // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
                const payload = JSON.parse(atob(parts[1]));
                const currentTime = Math.floor(Date.now() / 1000);
                if (payload.exp && payload.exp < currentTime) {
                    throw new Error('ä»¤ç‰Œå·²è¿‡æœŸ');
                }
                
                return true;
            } catch (error) {
                console.error('ä»¤ç‰ŒéªŒè¯å¤±è´¥:', error);
                alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                localStorage.removeItem('authToken');
                window.location.href = '/static/index.html';
                return false;
            }
        }

        // åˆ é™¤ Self-talk
        async function deleteSelfTalk(id) {
            // é¦–å…ˆæ£€æŸ¥è®¤è¯ä»¤ç‰Œ
            if (!checkAuthToken()) {
                return;
            }

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ Self-talk è®°å½•å—ï¼Ÿ')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/self_talks/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showStatus('recordingStatus', 'åˆ é™¤æˆåŠŸï¼', 'success');
                    loadHistory(); // åˆ·æ–°å†å²è®°å½•
                } else if (response.status === 401) {
                    // å¤„ç†è®¤è¯å¤±è´¥
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('authToken');
                    window.location.href = '/static/index.html';
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'æœªçŸ¥é”™è¯¯' }));
                    alert(`åˆ é™¤å¤±è´¥: ${errorData.detail || 'è¯·é‡è¯•'}`);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = '/static/index.html';
                return;
            }
            
            loadHistory();
        });
    </script>
</body>
</html>
